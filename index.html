<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üåä OpenFloodAI ‚Äî Global Flood Dashboard</title>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
integrity="sha256-SmHgJywY2OAtTSiVQF9Cqgk1jJZT5+M3qsGJjM8yE0E=" crossorigin=""></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Initialize the map AFTER DOM is loaded
  const map = L.map('map').setView([20, 0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  fetch('data/outputs/all_forecasts.json')
    .then(resp => {
      if (!resp.ok) throw new Error("Failed to load forecasts");
      return resp.json();
    })
    .then(data => {
      const forecasts = data.forecasts || {};
      const container = document.getElementById('forecast-container');
      const tableBody = document.getElementById('forecast-table-body');
      const filterSelect = document.getElementById('region-filter');

      // If forecasts is empty, show warning
      if (Object.keys(forecasts).length === 0) {
        container.innerHTML = "‚ö†Ô∏è No forecast data available.";
        return;
      }

      // Populate dropdown
      Object.keys(forecasts).forEach(region => {
        const opt = document.createElement('option');
        opt.value = region;
        opt.textContent = region;
        filterSelect.appendChild(opt);
      });

      const updateDisplay = (selectedRegion = "all") => {
        container.innerHTML = '';
        tableBody.innerHTML = '';
        map.eachLayer(layer => {
          if (layer instanceof L.CircleMarker) map.removeLayer(layer);
        });

        Object.entries(forecasts).forEach(([region, values]) => {
          if (selectedRegion !== "all" && region !== selectedRegion) return;

          const div = document.createElement('div');
          div.className = `region ${values.tier}`;
          div.innerHTML = `
            <h3>${region}</h3>
            <p>Probability: ${(values.P_final * 100).toFixed(1)}%</p>
            <p>Tier: ${values.tier}</p>
          `;
          container.appendChild(div);

          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${region}</td>
            <td>${(values.P_final * 100).toFixed(1)}%</td>
            <td>${values.tier}</td>
            <td>${data.timestamp}</td>
          `;
          tableBody.appendChild(row);

          // Only add marker if lat/lon are provided
          if (values.lat && values.lon) {
            const color = values.tier === "RED" ? "red" : values.tier === "AMBER" ? "orange" : "green";
            const marker = L.circleMarker([values.lat, values.lon], {
              color,
              radius: 8,
              fillOpacity: 0.8
            }).addTo(map).bindPopup(`<b>${region}</b><br>${(values.P_final * 100).toFixed(1)}% (${values.tier})`);
          }
        });
      };

      updateDisplay();
      filterSelect.addEventListener('change', e => updateDisplay(e.target.value));
    })
    .catch(err => {
      console.error(err);
      document.getElementById('forecast-container').innerHTML = "‚ö†Ô∏è Error loading forecast data.";
    });
});
</script>
</style>
</head>
<body>

<header>
  <img src="logo.svg" alt="OpenFloodAI logo">
  <h1>üåä OpenFloodAI ‚Äî Global Flood Dashboard</h1>
</header>

<div class="controls">
  <label for="region-filter">üåé Select region:</label>
  <select id="region-filter">
    <option value="all">All Regions</option>
  </select>
</div>

<div id="map"></div>

<main style="padding:20px;">
  <div id="forecast-container"></div>
  
  <h2>Regional Forecast Summary</h2>
  <table id="forecast-table">
    <thead>
      <tr>
        <th>Region</th>
        <th>Probability</th>
        <th>Tier</th>
        <th>Last Updated</th>
      </tr>
    </thead>
    <tbody id="forecast-table-body"></tbody>
  </table>
</main>

<footer>üåç OpenFloodAI ‚Äî Open and free flood forecasting for all. Updated daily.</footer>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-SmHgJywY2OAtTSiVQF9Cqgk1jJZT5+M3qsGJjM8yE0E=" crossorigin=""></script>
<script>
const map = L.map('map').setView([20, 0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

fetch('data/outputs/all_forecasts.json')
  .then(resp => resp.json())
  .then(data => {
    const forecasts = data.forecasts;
    const container = document.getElementById('forecast-container');
    const tableBody = document.getElementById('forecast-table-body');
    const filterSelect = document.getElementById('region-filter');

    // populate dropdown
    Object.keys(forecasts).forEach(region => {
      const opt = document.createElement('option');
      opt.value = region;
      opt.textContent = region;
      filterSelect.appendChild(opt);
    });

    const updateDisplay = (selectedRegion = "all") => {
      container.innerHTML = '';
      tableBody.innerHTML = '';
      map.eachLayer(layer => { if (layer instanceof L.Marker) map.removeLayer(layer); });

      Object.entries(forecasts).forEach(([region, values]) => {
        if (selectedRegion !== "all" && region !== selectedRegion) return;

        const div = document.createElement('div');
        div.className = `region ${values.tier}`;
        div.innerHTML = `
          <h3>${region}</h3>
          <p>Probability: ${(values.P_final * 100).toFixed(1)}%</p>
          <p>Tier: ${values.tier}</p>
        `;
        container.appendChild(div);

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${region}</td>
          <td>${(values.P_final * 100).toFixed(1)}%</td>
          <td>${values.tier}</td>
          <td>${data.timestamp}</td>
        `;
        tableBody.appendChild(row);

        if (values.lat && values.lon) {
          const color = values.tier === "RED" ? "red" : values.tier === "AMBER" ? "orange" : "green";
          const marker = L.circleMarker([values.lat, values.lon], {
            color,
            radius: 8,
            fillOpacity: 0.8
          }).addTo(map).bindPopup(`<b>${region}</b><br>${(values.P_final * 100).toFixed(1)}% (${values.tier})`);
        }
      });
    };

    updateDisplay();
    filterSelect.addEventListener('change', e => updateDisplay(e.target.value));
  })
  .catch(() => {
    document.getElementById('forecast-container').innerHTML = "‚ö†Ô∏è Forecast data not available.";
  });
</script>
</body>
</html>
